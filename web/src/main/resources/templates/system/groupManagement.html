<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>组织机构</title>
    <link rel="shortcut icon" th:href="@{favicon.ico}"> <link th:href="@{hplus/css/bootstrap.min14ed.css}" rel="stylesheet">
    <link th:href="@{hplus/css/font-awesome.min93e3.css}" rel="stylesheet">
    <link th:href="@{hplus/css/plugins/iCheck/custom.css}" rel="stylesheet">
    <link th:href="@{hplus/css/plugins/summernote/summernote.css}" rel="stylesheet">
    <link th:href="@{hplus/css/plugins/summernote/summernote-bs3.css}" rel="stylesheet">
    <link th:href="@{hplus/css/animate.min.css}" rel="stylesheet">
    <link th:href="@{hplus/css/style.min862f.css}" rel="stylesheet">
    <script th:src="@{hplus/js/jquery.min.js}"></script>
    <script th:src="@{hplus/js/bootstrap.min.js}"></script>
    <script th:src="@{hplus/js/content.min.js}"></script>
    <script th:src="@{hplus/js/plugins/iCheck/icheck.min.js}"></script>
    <script th:src="@{hplus/js/plugins/summernote/summernote.min.js}"></script>
    <script th:src="@{hplus/js/plugins/summernote/summernote-zh-CN.js}"></script>
    <link rel="stylesheet" href="js/lib/zTree_v3/css/zTreeStyle/zTreeStyle.css" type="text/css">
	<script type="text/javascript" src="js/lib/zTree_v3/js/jquery.ztree.core.js"></script>
	<script type="text/javascript" src="js/lib/zTree_v3/js/jquery.ztree.excheck.js"></script>
	<script type="text/javascript" src="js/lib/zTree_v3/js/jquery.ztree.exedit.js"></script>

</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-sm-3">
                <div id="orgTree" class="ztree"></div>
				<div class="hidden">
					<div id="orgMenu" class="easyui-menu" data-options="onClick:menuHandler" style="width: 120px;">
						<div data-options="name:'add'">添加子级组织</div>
						 <div data-options="name:'edit'" >编辑当前组织</div> 
						 <div data-options="name:'remove'" >删除当前组织</div> 
						 <div data-options="name:'fresh'">刷新</div>
					</div>
				</div>
            </div>
            <div class="col-sm-9 animated fadeInRight">
                <iframe id="listFrame" src="" style="border:0;"  width="100%" height="100%"></iframe>
            </div>
        </div>
    </div>
   
    
    <script>
  //加载树
    var orgTree ;
    function loadTree() {
    	var ztreeCreator = new ZtreeCreator('orgTree', __ctx + "/org/group/getTreeData")
     			.setCallback({onClick:zTreeOnLeftClick,onRightClick:zTreeOnRightClick})
     			.initZtree({},function(treeObj){orgTree = treeObj});

    };

    //左击
    function zTreeOnLeftClick(event, treeId, treeNode) {
    	curSelectNode = treeNode;
    	var parentId = treeNode.id;
    	var url = "groupTabs.html?id=" + curSelectNode.id;
    	if(curSelectNode.id=="0"){
    		$.Toast.error("该节点为根节点，请点击具体的组织");
    		return false;
    	}
    	$("#listFrame").attr("src", url);
    };
    /**
     * 树右击事件
     */
    function zTreeOnRightClick(e, treeId, treeNode) {
    	if (treeNode) {
    		orgTree.selectNode(treeNode);
    		curSelectNode=treeNode;
    		var isfolder = treeNode.isFolder;
    		var h = $(window).height();
    		var w = $(window).width();
    		var menuWidth = 120;
    		var menuHeight = 75;
    		var menu = null;
    		if (treeNode != null) {
    			menu = $('#orgMenu');
    		}
    		var x = e.pageX, y = e.pageY;
    		if (e.pageY + menuHeight > h) {
    			y = e.pageY - menuHeight;
    		}
    		if (e.pageX + menuWidth > w) {
    			x = e.pageX - menuWidth;
    		}
    		menu.menu('show', {
    			left : x,
    			top : y
    		});
    	}
    };
    //菜单对应项
    function menuHandler(item) {
    	if ('add' == item.name) {
    		editNode(0);
    	} else if ('remove' == item.name) {
    		delNode();
    	} else if ('sort' == item.name) {
    		sortNode();
    	} else if ('edit' == item.name) {
    		editNode(1);
    	} else if ('fresh' == item.name) {
    		refreshNode();
    	}
    };
    function refreshNode() {
    	loadTree();
    };
    //添加节点
    function editNode(type) {
    	var selectNode = getSelectNode();
    	if (!selectNode) 	return;
    	var id=selectNode.id;
    	var url = "./groupEdit.html" ;
    	url+=(type==1) ? "?id=" + id : "?parentId=" + id + "&parentOrgName="+ selectNode.name; 
    	$("#listFrame").attr("src", url);

    };


    //删除
    function delNode() {
    	var selectNode = getSelectNode();
    	var nodeId = selectNode.id;
    	if (nodeId == "0") {
    		$.topCall.warn('该节点为根节点，不可删除');
    		return;
    	} 
     
    	var callback = function() {
    		var url = __ctx+"/org/group/remove";
    		var params = {
    			id : nodeId
    		};
    		$.post(url, params, function(data) {
    			var obj = JSON.parse(data);
    			if (obj.isOk) {//成功
    				orgTree.removeNode(selectNode);
    				$("#listFrame").attr("src", "about:blank");
    			} else {
    				$.Dialog.error(obj.msg);
    			}
    			refreshNode();
    		});
    	};
    	$.Dialog.confirm('温馨提示', '确定删除？', callback);
    };
    //选择资源节点。
    function getSelectNode() {
    	orgTree = $.fn.zTree.getZTreeObj("orgTree");
    	var nodes = orgTree.getSelectedNodes();
    	var node = nodes[0];
    	return node;
    };
    </script>
    
    <script type="text/javascript">
    
    $(function() {
		loadTree();
	});
    </script>
</body>
</html>
